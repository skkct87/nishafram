"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _htmlGenerator = _interopRequireDefault(require("./htmlGenerator"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const fs = require('fs-extra');

const path = require('path');

const moment = require('moment');

const logger = require('@log4js-node/log4js-api');

function walk(dir, extensions, filelist = []) {
  const files = fs.readdirSync(dir);
  files.forEach(function (file) {
    const filepath = path.join(dir, file);
    const stat = fs.statSync(filepath);

    if (stat.isDirectory()) {
      filelist = walk(filepath, extensions, filelist);
    } else {
      extensions.forEach(function (extension) {
        if (file.indexOf(extension) == file.length - extension.length) {
          filelist.push(filepath);
        }
      });
    }
  });
  return filelist;
}

class ReportAggregator {
  constructor(opts) {
    opts = Object.assign({}, {
      outputDir: 'reports/html-reports/',
      filename: 'master-report.html',
      reportTitle: 'Test Master Report',
      showInBrowser: false,
      templateFilename: path.resolve(__dirname, '../src/wdio-html-reporter-template.hbs'),
      templateFuncs: {},
      LOG: null
    }, opts);
    this.options = opts;

    if (!this.options.LOG) {
      this.options.LOG = logger.getLogger("default");
    }

    this.options.reportFile = path.join(process.cwd(), this.options.outputDir, this.options.filename);
    this.reports = [];
  }

  clean() {
    fs.emptyDirSync(this.options.outputDir);
  }

  readJsonFiles() {
    return walk(this.options.outputDir, [".json"]);
  }

  log(message, object) {
    if (this.options.LOG) {
      this.options.LOG.debug(message + object);
    }
  }

  async createReport(results) {
    let metrics = {
      passed: 0,
      skipped: 0,
      failed: 0,
      start: moment("2048-01-01T01:00:00-08:00"),
      end: moment("2000-01-01T01:00:00-08:00"),
      duration: 0
    };
    let suites = [];
    let specs = [];
    let files = this.readJsonFiles();

    for (let i = 0; i < files.length; i++) {
      try {
        let filename = files[i];
        let report = JSON.parse(fs.readFileSync(filename));
        report.info.specs.forEach(spec => {
          specs.push(spec);
        });
        this.reports.push(report);
        metrics.passed += report.metrics.passed;
        metrics.failed += report.metrics.failed;
        metrics.skipped += report.metrics.skipped;

        for (let k = 0; k < report.suites.length; k++) {
          let suite = report.suites[k];
          let start = moment.utc(suite.start);

          if (start.isSameOrBefore(metrics.start)) {
            metrics.start = start;
          }

          let end = moment.utc(suite.end);

          if (end.isAfter(metrics.end)) {
            metrics.end = end;
          }

          suites.push(suite);
        }
      } catch (ex) {
        console.error(ex);
      }
    }

    metrics.duration = moment.duration(metrics.end.diff(metrics.start), "milliseconds").format('hh:mm:ss.SS', {
      trim: false
    });
    metrics.start = metrics.start.format();
    metrics.end = metrics.end.format();
    const reportOptions = {
      data: {
        info: this.reports[0].info,
        specs: specs,
        metrics: metrics,
        suites: suites,
        title: this.options.reportTitle
      },
      outputDir: this.options.outputDir,
      reportFile: this.options.reportFile,
      templateFilename: this.options.templateFilename,
      LOG: this.options.LOG,
      templateFuncs: this.options.templateFuncs,
      showInBrowser: this.options.showInBrowser
    };

    _htmlGenerator.default.htmlOutput(reportOptions);
  }

}

var _default = ReportAggregator;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXBvcnRBZ2dyZWdhdG9yLmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsInBhdGgiLCJtb21lbnQiLCJsb2dnZXIiLCJ3YWxrIiwiZGlyIiwiZXh0ZW5zaW9ucyIsImZpbGVsaXN0IiwiZmlsZXMiLCJyZWFkZGlyU3luYyIsImZvckVhY2giLCJmaWxlIiwiZmlsZXBhdGgiLCJqb2luIiwic3RhdCIsInN0YXRTeW5jIiwiaXNEaXJlY3RvcnkiLCJleHRlbnNpb24iLCJpbmRleE9mIiwibGVuZ3RoIiwicHVzaCIsIlJlcG9ydEFnZ3JlZ2F0b3IiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJvdXRwdXREaXIiLCJmaWxlbmFtZSIsInJlcG9ydFRpdGxlIiwic2hvd0luQnJvd3NlciIsInRlbXBsYXRlRmlsZW5hbWUiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwidGVtcGxhdGVGdW5jcyIsIkxPRyIsIm9wdGlvbnMiLCJnZXRMb2dnZXIiLCJyZXBvcnRGaWxlIiwicHJvY2VzcyIsImN3ZCIsInJlcG9ydHMiLCJjbGVhbiIsImVtcHR5RGlyU3luYyIsInJlYWRKc29uRmlsZXMiLCJsb2ciLCJtZXNzYWdlIiwib2JqZWN0IiwiZGVidWciLCJjcmVhdGVSZXBvcnQiLCJyZXN1bHRzIiwibWV0cmljcyIsInBhc3NlZCIsInNraXBwZWQiLCJmYWlsZWQiLCJzdGFydCIsImVuZCIsImR1cmF0aW9uIiwic3VpdGVzIiwic3BlY3MiLCJpIiwicmVwb3J0IiwiSlNPTiIsInBhcnNlIiwicmVhZEZpbGVTeW5jIiwiaW5mbyIsInNwZWMiLCJrIiwic3VpdGUiLCJ1dGMiLCJpc1NhbWVPckJlZm9yZSIsImlzQWZ0ZXIiLCJleCIsImNvbnNvbGUiLCJlcnJvciIsImRpZmYiLCJmb3JtYXQiLCJ0cmltIiwicmVwb3J0T3B0aW9ucyIsImRhdGEiLCJ0aXRsZSIsIkh0bWxHZW5lcmF0b3IiLCJodG1sT3V0cHV0Il0sIm1hcHBpbmdzIjoi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S0FBekIsQ0FBaEIsRUFBaUQsY0FBakQsRUFBaUVxQixNQUFqRSxDQUF3RSxhQUF4RSxFQUF1RjtBQUFDQyxNQUFBQSxJQUFJLEVBQUU7QUFBUCxLQUF2RixDQUFuQjtBQUNBMUIsSUFBQUEsT0FBTyxDQUFDSSxLQUFSLEdBQWdCSixPQUFPLENBQUNJLEtBQVIsQ0FBY3FCLE1BQWQsRUFBaEI7QUFDQXpCLElBQUFBLE9BQU8sQ0FBQ0ssR0FBUixHQUFjTCxPQUFPLENBQUNLLEdBQVIsQ0FBWW9CLE1BQVosRUFBZDtBQUVBLFVBQU1FLGFBQWEsR0FBRztBQUNsQkMsTUFBQUEsSUFBSSxFQUFFO0FBQ0ZkLFFBQUFBLElBQUksRUFBRSxLQUFLeEIsT0FBTCxDQUFhLENBQWIsRUFBZ0J3QixJQURwQjtBQUVGTixRQUFBQSxLQUFLLEVBQUNBLEtBRko7QUFHRlIsUUFBQUEsT0FBTyxFQUFFQSxPQUhQO0FBSUZPLFFBQUFBLE1BQU0sRUFBRUEsTUFKTjtBQUtGc0IsUUFBQUEsS0FBSyxFQUFFLEtBQUs1QyxPQUFMLENBQWFQO0FBTGxCLE9BRFk7QUFRbEJGLE1BQUFBLFNBQVMsRUFBRSxLQUFLUyxPQUFMLENBQWFULFNBUk47QUFTbEJXLE1BQUFBLFVBQVUsRUFBRSxLQUFLRixPQUFMLENBQWFFLFVBVFA7QUFVbEJQLE1BQUFBLGdCQUFnQixFQUFFLEtBQUtLLE9BQUwsQ0FBYUwsZ0JBVmI7QUFXbEJJLE1BQUFBLEdBQUcsRUFBRyxLQUFLQyxPQUFMLENBQWFELEdBWEQ7QUFZbEJELE1BQUFBLGFBQWEsRUFBRSxLQUFLRSxPQUFMLENBQWFGLGFBWlY7QUFhbEJKLE1BQUFBLGFBQWEsRUFBRSxLQUFLTSxPQUFMLENBQWFOO0FBYlYsS0FBdEI7O0FBZ0JBbUQsMkJBQWNDLFVBQWQsQ0FBeUJKLGFBQXpCO0FBRUg7O0FBeEdrQjs7ZUEyR0p4RCxnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBIdG1sR2VuZXJhdG9yIGZyb20gXCIuL2h0bWxHZW5lcmF0b3JcIjtcclxuXHJcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50Jyk7XHJcbmNvbnN0IGxvZ2dlciA9IHJlcXVpcmUoJ0Bsb2c0anMtbm9kZS9sb2c0anMtYXBpJyk7XHJcblxyXG5mdW5jdGlvbiAgd2FsayhkaXIsIGV4dGVuc2lvbnMgLCBmaWxlbGlzdCA9IFtdKSB7XHJcbiAgICBjb25zdCBmaWxlcyA9IGZzLnJlYWRkaXJTeW5jKGRpcik7XHJcblxyXG4gICAgZmlsZXMuZm9yRWFjaChmdW5jdGlvbiAoZmlsZSkge1xyXG4gICAgICAgIGNvbnN0IGZpbGVwYXRoID0gcGF0aC5qb2luKGRpciwgZmlsZSk7XHJcbiAgICAgICAgY29uc3Qgc3RhdCA9IGZzLnN0YXRTeW5jKGZpbGVwYXRoKTtcclxuXHJcbiAgICAgICAgaWYgKHN0YXQuaXNEaXJlY3RvcnkoKSkge1xyXG4gICAgICAgICAgICBmaWxlbGlzdCA9IHdhbGsoZmlsZXBhdGgsIGV4dGVuc2lvbnMsIGZpbGVsaXN0KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBleHRlbnNpb25zLmZvckVhY2goZnVuY3Rpb24gKGV4dGVuc2lvbikge1xyXG4gICAgICAgICAgICAgICAgaWYgKGZpbGUuaW5kZXhPZihleHRlbnNpb24pID09IGZpbGUubGVuZ3RoIC0gZXh0ZW5zaW9uLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGZpbGVsaXN0LnB1c2goZmlsZXBhdGgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gZmlsZWxpc3Q7XHJcbn1cclxuXHJcbmNsYXNzIFJlcG9ydEFnZ3JlZ2F0b3Ige1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG9wdHMpIHtcclxuICAgICAgICBvcHRzID0gT2JqZWN0LmFzc2lnbih7fSwge1xyXG4gICAgICAgICAgICBvdXRwdXREaXI6ICdyZXBvcnRzL2h0bWwtcmVwb3J0cy8nLFxyXG4gICAgICAgICAgICBmaWxlbmFtZTogJ21hc3Rlci1yZXBvcnQuaHRtbCcsXHJcbiAgICAgICAgICAgIHJlcG9ydFRpdGxlOiAnVGVzdCBNYXN0ZXIgUmVwb3J0JyxcclxuICAgICAgICAgICAgc2hvd0luQnJvd3NlcjogZmFsc2UsXHJcbiAgICAgICAgICAgIHRlbXBsYXRlRmlsZW5hbWU6IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLi9zcmMvd2Rpby1odG1sLXJlcG9ydGVyLXRlbXBsYXRlLmhicycpLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZUZ1bmNzOiB7fSxcclxuICAgICAgICAgICAgTE9HOiBudWxsXHJcbiAgICAgICAgfSwgb3B0cyk7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0cztcclxuICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5MT0cpIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLkxPRyA9IGxvZ2dlci5nZXRMb2dnZXIoXCJkZWZhdWx0XCIpICAgICAgO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLm9wdGlvbnMucmVwb3J0RmlsZSA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCB0aGlzLm9wdGlvbnMub3V0cHV0RGlyLCB0aGlzLm9wdGlvbnMuZmlsZW5hbWUpO1xyXG4gICAgICAgIHRoaXMucmVwb3J0cyA9IFtdO1xyXG4gICAgfVxyXG5cclxuICAgIGNsZWFuKCkge1xyXG4gICAgICAgIGZzLmVtcHR5RGlyU3luYyh0aGlzLm9wdGlvbnMub3V0cHV0RGlyKTtcclxuICAgIH1cclxuXHJcblxyXG5cclxuICAgIHJlYWRKc29uRmlsZXMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHdhbGsodGhpcy5vcHRpb25zLm91dHB1dERpciwgW1wiLmpzb25cIl0pO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBsb2cobWVzc2FnZSxvYmplY3QpIHtcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLkxPRykge1xyXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMuTE9HLmRlYnVnKG1lc3NhZ2UgKyBvYmplY3QpIDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBhc3luYyBjcmVhdGVSZXBvcnQocmVzdWx0cykge1xyXG5cclxuICAgICAgICBsZXQgbWV0cmljcyA9IHtcclxuICAgICAgICAgICAgcGFzc2VkOiAwLFxyXG4gICAgICAgICAgICBza2lwcGVkOiAwLFxyXG4gICAgICAgICAgICBmYWlsZWQ6IDAsXHJcbiAgICAgICAgICAgIHN0YXJ0IDogbW9tZW50KFwiMjA0OC0wMS0wMVQwMTowMDowMC0wODowMFwiKSxcclxuICAgICAgICAgICAgZW5kIDogbW9tZW50KFwiMjAwMC0wMS0wMVQwMTowMDowMC0wODowMFwiKSxcclxuICAgICAgICAgICAgZHVyYXRpb246IDBcclxuICAgICAgICB9O1xyXG4gICAgICAgIGxldCBzdWl0ZXMgPSBbXTtcclxuICAgICAgICBsZXQgc3BlY3MgPSBbXTtcclxuXHJcbiAgICAgICAgbGV0IGZpbGVzID0gdGhpcy5yZWFkSnNvbkZpbGVzKCk7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmlsZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGxldCBmaWxlbmFtZSA9IGZpbGVzW2ldO1xyXG4gICAgICAgICAgICAgICAgbGV0IHJlcG9ydCA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKGZpbGVuYW1lKSk7XHJcbiAgICAgICAgICAgICAgICByZXBvcnQuaW5mby5zcGVjcy5mb3JFYWNoKChzcGVjKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3BlY3MucHVzaChzcGVjKSA7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5yZXBvcnRzLnB1c2gocmVwb3J0KTtcclxuICAgICAgICAgICAgICAgIG1ldHJpY3MucGFzc2VkICs9IHJlcG9ydC5tZXRyaWNzLnBhc3NlZDtcclxuICAgICAgICAgICAgICAgIG1ldHJpY3MuZmFpbGVkICs9IHJlcG9ydC5tZXRyaWNzLmZhaWxlZDtcclxuICAgICAgICAgICAgICAgIG1ldHJpY3Muc2tpcHBlZCArPSByZXBvcnQubWV0cmljcy5za2lwcGVkO1xyXG5cclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgcmVwb3J0LnN1aXRlcy5sZW5ndGg7IGsrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdWl0ZSA9IHJlcG9ydC5zdWl0ZXNba10gO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdGFydCA9IG1vbWVudC51dGMoc3VpdGUuc3RhcnQpIDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIHN0YXJ0LmlzU2FtZU9yQmVmb3JlKG1ldHJpY3Muc3RhcnQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldHJpY3Muc3RhcnQgPSAgc3RhcnQgO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBsZXQgZW5kID0gbW9tZW50LnV0YyhzdWl0ZS5lbmQpIDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIGVuZC5pc0FmdGVyKG1ldHJpY3MuZW5kKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRyaWNzLmVuZCA9ICBlbmQgO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBzdWl0ZXMucHVzaChzdWl0ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGV4KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICAgICAgbWV0cmljcy5kdXJhdGlvbiA9IG1vbWVudC5kdXJhdGlvbihtZXRyaWNzLmVuZC5kaWZmKG1ldHJpY3Muc3RhcnQpLCBcIm1pbGxpc2Vjb25kc1wiKS5mb3JtYXQoJ2hoOm1tOnNzLlNTJywge3RyaW06IGZhbHNlfSk7XHJcbiAgICAgICAgbWV0cmljcy5zdGFydCA9IG1ldHJpY3Muc3RhcnQuZm9ybWF0KCkgO1xyXG4gICAgICAgIG1ldHJpY3MuZW5kID0gbWV0cmljcy5lbmQuZm9ybWF0KCkgO1xyXG5cclxuICAgICAgICBjb25zdCByZXBvcnRPcHRpb25zID0ge1xyXG4gICAgICAgICAgICBkYXRhOiB7XHJcbiAgICAgICAgICAgICAgICBpbmZvOiB0aGlzLnJlcG9ydHNbMF0uaW5mbyxcclxuICAgICAgICAgICAgICAgIHNwZWNzOnNwZWNzLFxyXG4gICAgICAgICAgICAgICAgbWV0cmljczogbWV0cmljcyxcclxuICAgICAgICAgICAgICAgIHN1aXRlczogc3VpdGVzLFxyXG4gICAgICAgICAgICAgICAgdGl0bGU6IHRoaXMub3B0aW9ucy5yZXBvcnRUaXRsZSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgb3V0cHV0RGlyOiB0aGlzLm9wdGlvbnMub3V0cHV0RGlyLFxyXG4gICAgICAgICAgICByZXBvcnRGaWxlOiB0aGlzLm9wdGlvbnMucmVwb3J0RmlsZSxcclxuICAgICAgICAgICAgdGVtcGxhdGVGaWxlbmFtZTogdGhpcy5vcHRpb25zLnRlbXBsYXRlRmlsZW5hbWUsXHJcbiAgICAgICAgICAgIExPRyA6IHRoaXMub3B0aW9ucy5MT0csXHJcbiAgICAgICAgICAgIHRlbXBsYXRlRnVuY3M6IHRoaXMub3B0aW9ucy50ZW1wbGF0ZUZ1bmNzLFxyXG4gICAgICAgICAgICBzaG93SW5Ccm93c2VyOiB0aGlzLm9wdGlvbnMuc2hvd0luQnJvd3NlclxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIEh0bWxHZW5lcmF0b3IuaHRtbE91dHB1dChyZXBvcnRPcHRpb25zKTtcclxuXHJcbiAgICB9XHJcbn1cclxuXHJcbiAgICBleHBvcnQgZGVmYXVsdCBSZXBvcnRBZ2dyZWdhdG9yO1xyXG4iXX0=